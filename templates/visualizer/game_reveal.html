{% extends "base.html" %}
{% block title %}
对局重放 - {{ game_id }}
{% endblock title %}
{% block styles %}
<link rel="stylesheet" href="../../static/css/medieval.css">
{{ super() }}
<style>
    /* 基础响应式设置 */
    :root {
        --sidebar-width: 300px;
        --chat-width: 600px;
        --map-width: 300px;
    }

    @media (max-width: 768px) {
        :root {
            --sidebar-width: 100%;
            --chat-width: 100%;
            --map-width: 100%;
        }
    }

    .navbar {
        background: none !important;
        background-image: url('../../static/images/wood-texture.png') !important;
        background-size: cover !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    /* 开场动画样式 */
    .intro-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #222222;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 1;
        transition: opacity 0.5s ease-out;
    }

    .intro-animation.fade-out {
        opacity: 0;
    }

    .intro-content {
        text-align: center;
        color: #fff;
        padding: 1rem;
    }

    .intro-title {
        font-size: clamp(2rem, 5vw, 3rem);
        color: #ffffff;
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease forwards;
    }

    .intro-subtitle {
        font-size: clamp(1rem, 3vw, 1.5rem);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease 0.5s forwards;
    }

    .loading-bar {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        margin: 2rem auto;
        border-radius: 2px;
        overflow: hidden;
        opacity: 0;
        animation: fadeIn 0.5s ease 1s forwards;
    }

    .loading-progress {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #67b26f);
        animation: loading 2s ease 1s forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes loading {
        from {
            width: 0%;
        }

        to {
            width: 100%;
        }
    }

    /* 聊天容器样式 */
    .chat-container {
        height: calc(100vh - 250px);
        overflow-y: auto;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 200px);
            padding: 0.5rem;
        }
    }

    /* 消息样式 */
    .message-bubble {
        max-width: 100%;
        padding: 8px 12px;
        border-radius: 15px;
        position: relative;
        word-break: break-word;
        margin-bottom: 5px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message-blue {
        background-color: rgb(190, 208, 235);
        border: 1px solid #9ec5fe;
        color: #052c65;
    }

    .message-red {
        background-color: rgb(236, 207, 210);
        border: 1px solid #f5c2c7;
        color: #58151c;
    }

    .message-system {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
        text-align: center;
        padding: 6px 10px;
        font-size: 0.9em;
        margin: 10px auto;
        display: block;
        clear: both;
    }

    .message-wrapper {
        position: relative;
        max-width: 80%;
        margin-bottom: 15px;
        clear: both;
    }

    .message-wrapper-blue {
        float: none;
        margin: 0 auto;
        margin-bottom: 15px;
    }

    .message-wrapper-red {
        float: right;
        margin-right: 5px;
    }

    .player-tag {
        font-size: 0.8rem;
        margin-bottom: 2px;
        font-weight: bold;
        padding: 0 5px;
        display: block;
    }

    /* 回合分隔线 */
    .round-divider {
        clear: both;
        text-align: center;
        margin: 25px 0 15px 0;
        position: relative;
    }

    .round-divider:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
        z-index: 0;
    }

    .round-divider span {
        display: inline-block;
        padding: 5px 15px;
        position: relative;
        z-index: 1;
        font-weight: bold;
        border-radius: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
    }

    /* 地图样式 */
    .game-map {
        display: grid;
        grid-template-columns: repeat(var(--map-size), 1fr);
        grid-template-rows: repeat(var(--map-size), 1fr);
        gap: 0px;
        padding: 5px;
        border-radius: 4px;
        max-width: 100%;
        margin: 0 auto;
        border: 3px solid #9e8a5d;
    }

    .map-cell {
        aspect-ratio: 1;
        border: 1.3px solid #9e8a5d;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-weight: bold;
        font-size: 0.7rem;
    }

    .player-token {
        width: 85%;
        height: 85%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        cursor: help;
    }

    .player-blue {
        background-color: #4A6B8A;
    }

    .player-red {
        background-color: #8B0000;
    }

    .player-unknown {
        background-color: #6c757d;
    }

    /* 自动跳动回放高亮样式 */
    .auto-replay-active {
        background: #ffe082 !important;
        transition: background 0.3s;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(255, 224, 130, 0.5) !important;
    }

    /* TTS按钮样式 */
    .tts-play-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: #007bff;
        color: white;
        font-size: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        z-index: 10;
    }

    .tts-play-btn:hover {
        background: #0056b3;
        transform: scale(1.1);
    }

    .tts-play-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .tts-play-btn.loading {
        background: #ffc107;
        animation: pulse 1.5s infinite;
    }

    .tts-play-btn.playing {
        background: #28a745;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    /* 其他必要样式 */
    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }

    .vote-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 5px;
    }

    .mission-result-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
    }

    .sidebar {
        overflow-y: auto;
        max-height: calc(100vh - 100px);
    }

    .speech-badge,
    .hearers-tags {
        display: inline-block;
        margin-right: 2px;
        font-size: 0.65rem;
        margin-left: 5px;
        vertical-align: middle;
    }

    .private-speech {
        border-style: dashed;
        background-color: rgba(200, 200, 200, 0.3);
    }
</style>
{% endblock styles %}
{% block content %}
<!-- 开场动画 -->
<div class="intro-animation" id="introAnimation">
    <div class="intro-content">
        <h1 class="intro-title">阿瓦隆</h1>
        <p class="intro-subtitle">对局重放</p>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
</div>
<!-- 移动端导航切换按钮 -->
<div class="d-lg-none mb-2">
    <div class="btn-group w-100" role="group">
        <button type="button" class="btn btn-outline-primary active" data-view="main">游戏进程</button>
        <button type="button" class="btn btn-outline-primary" data-view="info">游戏信息</button>
    </div>
</div>
<div class="container-fluid mt-3">
    <div class="row">
        <!-- 左侧边栏：游戏信息和玩家列表 -->
        <div class="col-lg-3 col-md-4 mobile-view" id="infoView">
            <div class="sidebar">
                <!-- 游戏信息卡片 -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h5 class="mb-0 fs-6">对局信息</h5>
                    </div>
                    <div class="card-body p-2">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                <small>游戏ID</small>
                                <span class="badge bg-secondary rounded-pill">{{ game_id }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 玩家列表 -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h5 class="mb-0 fs-6">玩家列表 ({{ game_info.player_count }}人)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped table-bordered mb-0 small">
                                <thead class="table-light">
                                    <tr>
                                        <th>玩家</th>
                                        <th>用户名</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player_id, role in game_info.roles.items() | sort %}
                                    <tr>
                                        <td class="text-center">{{ player_id }}</td>
                                        {% if player_usernames %}
                                        <td>{{ player_usernames[player_id|int - 1] }}</td>
                                        {% else %}
                                        <td>未知</td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 中央：聊天记录主体和地图 -->
        <div class="col-lg-9 col-md-8 mobile-view" id="mainView">
            <div class="row">
                <!-- 聊天记录 -->
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div
                            class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 fs-6">对局流程</h4>
                            <span class="badge bg-light text-dark" id="currentRoundBadge">初始状态</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="chat-container" id="chatContainer">
                                <div class="text-center my-5 text-muted">
                                    <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                                    <p>加载对局流程中...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">逐条跳动回放</small>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="scrollToBottomBtn"
                                        title="滚动到底部">
                                        <i class="bi bi-arrow-down-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2"
                                        id="autoplayBtnFlow">
                                        <i class="bi bi-play-fill"></i> 自动播放
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 游戏地图 -->
                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div
                            class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fs-6">游戏地图</h5>
                            <span class="badge bg-light text-dark" id="mapCurrentRoundDisplay">初始状态</span>
                        </div>
                        <div class="card-body p-2">
                            <div class="game-map" id="gameMap">
                                <div class="text-center text-muted p-3 small">地图加载中...</div>
                            </div>
                        </div>
                        <div class="card-footer text-center p-2">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="mapPrevRoundBtn"
                                    disabled>
                                    <i class="bi bi-chevron-left"></i> 上一轮
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="mapNextRoundBtn">
                                    下一轮 <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 设置地图大小变量
        document.documentElement.style.setProperty('--map-size', '{{ map_size }}');

        // --- 数据初始化 ---
        const gameEvents = JSON.parse('{{ game_events|tojson|safe }}');
        const playerMovements = JSON.parse('{{ player_movements|tojson|safe }}');
        const gameInfo = JSON.parse('{{ game_info|tojson|safe }}');
        const roles = gameInfo.roles || {};
        const mapSize = parseInt('{{ map_size }}');
        const gameId = "{{ game_id }}";

        // DOM元素
        const chatContainer = document.getElementById('chatContainer');
        const gameMapContainer = document.getElementById('gameMap');
        const currentRoundBadge = document.getElementById('currentRoundBadge');
        const autoplayBtnFlow = document.getElementById('autoplayBtnFlow');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const mapPrevRoundBtn = document.getElementById('mapPrevRoundBtn');
        const mapNextRoundBtn = document.getElementById('mapNextRoundBtn');
        const mapCurrentRoundDisplay = document.getElementById('mapCurrentRoundDisplay');

        let currentMapRound = 0;
        const maxRound = Math.max(
            gameEvents.length > 0 ?
                (gameEvents[gameEvents.length - 1].round === 'assassination' ?
                    (gameEvents.length > 1 ? gameEvents[gameEvents.length - 2].round : 0) :
                    gameEvents[gameEvents.length - 1].round) : 0,
            gameInfo.rounds_played || 0
        );

        // 角色信息
        const roleNames = {
            "Merlin": "梅林", "Percival": "派西维尔", "Knight1": "骑士", "Knight2": "骑士",
            "Assassin": "刺客", "Morgana": "莫甘娜", "Mordred": "莫德雷德", "Oberon": "奥伯伦"
        };
        const roleFactions = {
            "Merlin": "blue", "Percival": "blue", "Knight1": "blue", "Knight2": "blue",
            "Assassin": "red", "Morgana": "red", "Mordred": "red", "Oberon": "red"
        };

        let knightCount = 0;
        const knightAssignments = new Map();

        function getPlayerInfo(playerId) {
            const idStr = String(playerId);
            let role = roles[idStr] || '未知角色';
            if (role === 'Knight') {
                if (!knightAssignments.has(idStr)) {
                    knightCount++;
                    knightAssignments.set(idStr, knightCount);
                }
                role = knightAssignments.get(idStr) === 1 ? 'Knight1' : 'Knight2';
            }
            const name = roleNames[role] || role;
            const faction = 'red';
            return { id: idStr, role: role, name: name, faction: faction };
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- 自动逐条跳动回放功能 ---
        let isAutoReplay = false;
        let autoReplayTimeout = null;
        let currentReplayMsgIndex = 0;

        function getAllReplayMessages() {
            return Array.from(chatContainer.querySelectorAll('.message-bubble, .message-system, .move-message'));
        }

        function getMessageDelay(msgElem) {
            let text = '';
            if (msgElem.classList.contains('message-bubble')) {
                text = msgElem.innerText || '';
            } else if (msgElem.classList.contains('message-system') || msgElem.classList.contains('move-message')) {
                text = msgElem.innerText || '';
            }
            const base = 800;
            const perChar = 80;
            const minDelay = 1000, maxDelay = 4000;
            let delay = base + text.length * perChar;
            return Math.max(minDelay, Math.min(maxDelay, delay));
        }

        function startAutoReplay() {
            if (isAutoReplay) return;
            isAutoReplay = true;
            autoplayBtnFlow.innerHTML = '<i class="bi bi-pause-fill"></i> 暂停回放';
            autoplayBtnFlow.classList.remove('btn-outline-primary');
            autoplayBtnFlow.classList.add('btn-outline-warning');

            const messages = getAllReplayMessages();
            if (!messages.length) return;

            currentReplayMsgIndex = 0;
            autoReplayStep(messages);
        }

        function autoReplayStep(messages) {
            if (!isAutoReplay || currentReplayMsgIndex >= messages.length) {
                stopAutoReplay();
                return;
            }
            const msg = messages[currentReplayMsgIndex];
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messages.forEach(m => m.classList.remove('auto-replay-active'));
            msg.classList.add('auto-replay-active');

            autoReplayTimeout = setTimeout(() => {
                currentReplayMsgIndex++;
                autoReplayStep(messages);
            }, getMessageDelay(msg));
        }

        function stopAutoReplay() {
            isAutoReplay = false;
            clearTimeout(autoReplayTimeout);
            autoplayBtnFlow.innerHTML = '<i class="bi bi-play-fill"></i> 自动播放';
            autoplayBtnFlow.classList.remove('btn-outline-warning');
            autoplayBtnFlow.classList.add('btn-outline-primary');
            getAllReplayMessages().forEach(m => m.classList.remove('auto-replay-active'));
        }

        // 事件绑定
        if (autoplayBtnFlow) {
            autoplayBtnFlow.addEventListener('click', () => {
                if (isAutoReplay) {
                    stopAutoReplay();
                } else {
                    startAutoReplay();
                }
            });
        }

        chatContainer.addEventListener('mousedown', stopAutoReplay);
        chatContainer.addEventListener('wheel', stopAutoReplay);
        chatContainer.addEventListener('touchstart', stopAutoReplay);
        scrollToBottomBtn.addEventListener('click', scrollToBottom);

        // --- 生成聊天历史 ---
        function generateChatHistory() {
            let chatHtml = '';
            let msgId = 0;

            chatHtml += `
                <div class="round-divider" id="round-0">
                    <span class="badge bg-secondary">游戏开始</span>
                </div>
            `;

            gameEvents.forEach((event) => {
                if (event.round === 'assassination') {
                    chatHtml += `
                        <div class="round-divider" id="round-assassination">
                            <span class="badge bg-dark">刺杀阶段</span>
                        </div>`;
                    if (event.assassination) {
                        const assassinInfo = getPlayerInfo(event.assassination.assassin);
                        const targetInfo = getPlayerInfo(event.assassination.target);
                        chatHtml += `
                            <div class="message-system">
                                刺客 ${assassinInfo.id}号 (${assassinInfo.name}) 选择刺杀 ${targetInfo.id}号 (${targetInfo.name} - ${event.assassination.target_role}).<br>
                                结果: <span class="badge ${event.assassination.success ? 'bg-danger' : 'bg-success'}">${event.assassination.success ? '成功' : '失败'}</span>
                            </div>`;
                    }
                    return;
                }

                const roundNum = event.round;
                const missionSuccess = event.mission_result ? event.mission_result.success : null;

                chatHtml += `
                    <div class="round-divider" id="round-${roundNum}">
                        <span class="badge bg-secondary">第 ${roundNum} 轮任务</span>
                    </div>
                `;

                if (event.leader) {
                    const leaderInfo = getPlayerInfo(event.leader);
                    chatHtml += `
                        <div class="message-system">
                            <i class="bi bi-person-badge"></i> <strong>队长:</strong> ${leaderInfo.id}号 (${leaderInfo.name})<br>
                            <i class="bi bi-people-fill"></i> <strong>提议队伍:</strong>
                            ${event.team_members && event.team_members.length > 0
                            ? event.team_members.map(memberId => `<span class="badge bg-secondary mx-1">${getPlayerInfo(memberId).id}号</span>`).join('')
                            : '无'}
                        </div>
                    `;
                }

                if (event.events && event.events.length > 0) {
                    event.events.forEach(eventItem => {
                        if (eventItem.type === "move") {
                            const playerId = eventItem.data.player_id;
                            const validMoves = eventItem.data.valid_moves;
                            const lastMove = validMoves[validMoves.length - 1];
                            let lastMoveDisplay = "";

                            if (lastMove === "left") lastMoveDisplay = "⬅️ 向左";
                            else if (lastMove === "up") lastMoveDisplay = "⬆️ 向上";
                            else if (lastMove === "down") lastMoveDisplay = "⬇️ 向下";
                            else if (lastMove === "right") lastMoveDisplay = "➡️ 向右";

                            const newPos = eventItem.data.new_pos;
                            if (playerId) {
                                chatHtml += `
                                    <div class="message-system move-message">
                                        <i class="bi bi-person-badge"></i> <strong>${playerId}号 玩家</strong> 进行了移动<br>
                                        <strong>有效移动:</strong> ${lastMoveDisplay}<br>
                                        <strong>新位置:</strong> ${newPos}
                                    </div>
                                `;
                            }
                        } else if (eventItem.type === "speech") {
                            const [playerId, message, speechType, hearers] = eventItem.data;
                            const playerInfo = getPlayerInfo(playerId);
                            const wrapperClass = 'message-wrapper-blue';
                            const bubbleClass = `message-blue ${speechType === "private" ? "private-speech" : ""}`;

                            const speechBadge = speechType === "private"
                                ? '<span class="badge bg-secondary speech-badge">有限范围</span>'
                                : '<span class="badge bg-info text-dark speech-badge">公开</span>';

                            const hearersTags = speechType === "private" && hearers
                                ? `<span class="badge bg-secondary speech-badge">${hearers}</span>`
                                : '';

                            const speechId = `speech-${msgId}`;

                            chatHtml += `
                                <div class="message-wrapper ${wrapperClass}">
                                    <div class="message-content">
                                        <div class="player-tag">
                                            ${playerInfo.id}号 ${speechBadge} ${hearersTags ? `<div class="hearers-tags">${hearersTags}</div>` : ""}                     
                                        </div>
                                        <div class="message-bubble ${bubbleClass}" id="${speechId}" 
                                             data-player-id="${playerId}" 
                                             data-text="${message.replace(/"/g, '&quot;')}"
                                             data-battle-id="${gameId}">
                                            ${message}
                                            <button class="tts-play-btn" onclick="playTTS('${speechId}')" title="播放语音">
                                                <i class="bi bi-volume-up"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            `;
                        } else if (eventItem.type === "vote_attempt") {
                            const voteAttempt = eventItem.data;
                            const approved = voteAttempt.approved;
                            chatHtml += `
                                <div class="vote-info">
                                    <strong>队伍投票结果:</strong>
                                    <span class="badge fs-6 ${approved ? 'bg-success' : 'bg-warning text-dark'}">
                                        ${approved ? '通过' : '拒绝'}
                                    </span>
                                    <small class="text-muted">(${voteAttempt.approve_count || 0} 赞成 / ${voteAttempt.reject_count || 0} 反对)</small>
                                </div>`;
                        }
                        msgId++;
                    });
                }

                if (event.mission_execution) {
                    const execution = event.mission_execution;
                    const success = execution.success;
                    chatHtml += `
                        <div class="mission-result-info">
                            <div class="alert ${success ? 'alert-info' : 'alert-danger'} d-inline-block py-1 px-3">
                                <strong>任务 ${roundNum} 执行结果:</strong>
                                ${success ? '成功' : '失败'}
                                ${execution.fail_votes !== undefined ? ` (${execution.fail_votes} 票失败)` : ''}
                            </div>
                        </div>
                    `;
                }
                chatHtml += `<div class="clearfix"></div>`;
            });

            chatHtml += `
                <div class="round-divider">
                    <span class="badge bg-dark">游戏结束</span>
                </div>
                <div class="message-system">
                    <div class="alert ${gameInfo.winner === 'blue' ? 'alert-info' : (gameInfo.winner === 'red' ? 'alert-danger' : 'alert-secondary')} d-inline-block fw-bold">
                        ${gameInfo.winner === 'blue' ? '蓝方胜利!' : (gameInfo.winner === 'red' ? '红方胜利!' : '游戏结束')}
                    </div><br>
                    <small>原因: ${gameInfo.win_reason || '未知'}</small><br>
                </div>
            `;

            chatContainer.innerHTML = chatHtml;
            scrollToBottom();
        }

        // 移动端视图切换
        const viewButtons = document.querySelectorAll('[data-view]');
        const views = document.querySelectorAll('.mobile-view');

        function switchView(viewName) {
            views.forEach(view => {
                if (view.id === viewName + 'View') {
                    view.style.display = 'block';
                } else {
                    view.style.display = 'none';
                }
            });

            viewButtons.forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        viewButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchView(btn.dataset.view);
            });
        });

        // 初始化
        if (window.innerWidth <= 768) {
            switchView('main');
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                views.forEach(view => {
                    view.style.display = '';
                });
            }
        });

        // 开场动画
        setTimeout(() => {
            const introAnimation = document.getElementById('introAnimation');
            if (introAnimation) {
                introAnimation.classList.add('fade-out');
                setTimeout(() => {
                    introAnimation.style.display = 'none';
                }, 500);
            }
        }, 3000);

        // 初始化内容
        if (!gameInfo || !gameEvents || !playerMovements || mapSize <= 0) {
            chatContainer.innerHTML = `<div class="alert alert-danger m-3">错误：加载对局数据失败，部分信息缺失。请检查日志文件。</div>`;
            console.error("Game data missing:", { gameInfo, gameEvents, playerMovements, mapSize });
        } else {
            generateChatHistory();
        }

        // TTS功能（简化版）
        let currentAudio = null;
        let currentPlayingButton = null;

        window.playTTS = async function (speechId) {
            const speechElement = document.getElementById(speechId);
            if (!speechElement) return;

            const button = speechElement.querySelector('.tts-play-btn');
            if (!button) return;

            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio = null;
                setButtonState(currentPlayingButton, 'normal');
                currentPlayingButton = null;
            }

            const playerId = speechElement.dataset.playerId;
            const text = speechElement.dataset.text;
            const battleId = speechElement.dataset.battleId;

            if (!playerId || !text || !battleId) return;

            setButtonState(button, 'loading');

            try {
                const response = await fetch('/visualizer/api/tts/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        player_id: playerId,
                        battle_id: battleId,
                        roles: roles
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.audio_url) {
                        await playAudioFromUrl(data.audio_url, button);
                    }
                } else {
                    setButtonState(button, 'error');
                    setTimeout(() => setButtonState(button, 'normal'), 3000);
                }
            } catch (error) {
                console.error('TTS播放失败:', error);
                setButtonState(button, 'error');
                setTimeout(() => setButtonState(button, 'normal'), 3000);
            }
        };

        async function playAudioFromUrl(audioUrl, button) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(audioUrl);

                audio.addEventListener('canplay', () => {
                    setButtonState(button, 'playing');
                    currentAudio = audio;
                    currentPlayingButton = button;
                });

                audio.addEventListener('ended', () => {
                    setButtonState(button, 'normal');
                    currentAudio = null;
                    currentPlayingButton = null;
                    resolve();
                });

                audio.addEventListener('error', (e) => {
                    setButtonState(button, 'error');
                    setTimeout(() => setButtonState(button, 'normal'), 3000);
                    reject(new Error('音频播放失败'));
                });

                audio.play().catch(reject);
            });
        }

        function setButtonState(button, state) {
            if (!button) return;

            button.classList.remove('loading', 'playing', 'error');
            button.disabled = false;

            const icon = button.querySelector('i');
            if (!icon) return;

            switch (state) {
                case 'loading':
                    button.classList.add('loading');
                    button.disabled = true;
                    icon.className = 'bi bi-hourglass-split';
                    button.title = '正在生成语音...';
                    break;
                case 'playing':
                    button.classList.add('playing');
                    icon.className = 'bi bi-pause-fill';
                    button.title = '正在播放';
                    break;
                case 'error':
                    button.classList.add('error');
                    button.disabled = true;
                    icon.className = 'bi bi-exclamation-triangle';
                    button.title = '语音生成失败';
                    break;
                case 'normal':
                default:
                    icon.className = 'bi bi-volume-up';
                    button.title = '播放语音';
                    break;
            }
        }
    });
</script>
{% endblock scripts %}